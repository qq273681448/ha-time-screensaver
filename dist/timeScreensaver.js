class ScreenSaver{constructor(t={}){this.initializeConfig(t),this.initializeState(),this.createElements(),this.bindEvents(),this.initializeHassIntegration(),this.resetTimer()}initializeConfig(t){const e=new URLSearchParams(window.location.search);this.timeout=1e3*(t.timeout||60),this.allPage=e.get("allPage"),this.screenId=e.get("screenId"),this.manual=e.get("screenTime")>1,this.hassElement=t.hassElement}initializeState(){this.timer=null,this.isActive=!1,this.lastButtonPress=null}createElements(){this.createContainer(),this.createClock(),this.createWeekday(),this.createDate(),this.appendElements()}createContainer(){this.container=document.createElement("div"),this.container.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: #000;\n            display: none;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n        "}createClock(){this.clock=document.createElement("div"),this.clock.style.cssText="\n            color: #fff;\n            font-size: 32vw;\n            font-family: Arial, sans-serif;\n            font-weight: bold;\n            text-shadow: 0 0 20px rgba(255,255,255,0.5);\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            width: 100%;\n            height: 100%;\n        "}createWeekday(){this.weekday=document.createElement("div"),this.weekday.style.cssText="\n            position: absolute;\n            right: 30px;\n            bottom: 30px;\n            color: #fff;\n            font-size: 3vw;\n            font-family: Arial, sans-serif;\n            opacity: 0.8;\n        "}createDate(){this.date=document.createElement("div"),this.date.style.cssText="\n            position: absolute;\n            left: 30px;\n            bottom: 30px;\n            color: #fff;\n            font-size: 3vw;\n            font-family: Arial, sans-serif;\n            opacity: 0.8;\n        "}appendElements(){this.container.appendChild(this.clock),this.container.appendChild(this.weekday),this.container.appendChild(this.date),document.body.appendChild(this.container)}bindEvents(){["mousemove","keydown","touchstart"].forEach((t=>{document.addEventListener(t,(()=>this.handleUserActivity()))})),this.container.addEventListener("click",(()=>this.handleUserActivity())),window.addEventListener("popstate",this.handleUrlChange.bind(this))}initializeHassIntegration(){this.hassElement&&this.hassElement.hass.connection.subscribeEvents((()=>this.onHassChanged()),"state_changed")}handleUserActivity(){this.isActive&&this.hide(),this.resetTimer()}handleUrlChange(){if("0"===this.allPage){window.location.pathname.startsWith("/lovelace")?this.resetTimer():(this.hide(),this.clearTimer())}}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=null)}resetTimer(){this.clearTimer(),"0"===this.allPage?window.location.pathname.startsWith("/lovelace")&&(this.timer=setTimeout((()=>this.show()),this.timeout)):this.timer=setTimeout((()=>this.show()),this.timeout)}show(){this.isActive=!0,this.container.style.display="flex",this.updateClock()}hide(){this.isActive=!1,this.container.style.display="none"}updateClock(){if(!this.isActive)return;const t=new Date;this.updateTimeDisplay(t),this.updateWeekdayDisplay(t),this.updateDateDisplay(t),requestAnimationFrame((()=>this.updateClock()))}updateTimeDisplay(t){const e=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0");this.clock.textContent=`${e}:${s}`}updateWeekdayDisplay(t){this.weekday.textContent=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][t.getDay()]}updateDateDisplay(t){const e=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");this.date.textContent=`${e}-${s}-${i}`}onHassChanged(){try{this.handleButtonState(),this.handleTimeoutUpdate()}catch(t){console.log("状态检查失败",t)}}handleButtonState(){const t=this.screenId?`input_button.screen_saver_bt_${this.screenId}`:"input_button.screen_saver_bt",e=this.hassElement.hass.states[t];e&&e.last_changed!==this.lastButtonPress&&(this.lastButtonPress=e.last_changed,this.isActive&&(console.log("通过按钮关闭屏保 "+(this.screenId?"(screenId: "+this.screenId+")":"")),this.hide(),this.resetTimer()))}handleTimeoutUpdate(){const t=this.hassElement.hass.states["input_number.screen_saver_timeout"];if(t&&0==this.manual){const e=parseFloat(t.state);e!==this.timeout/1e3&&(console.log(`屏保时间已更新: ${e} 秒`),this.timeout=1e3*e,this.resetTimer())}}destroy(){window.removeEventListener("popstate",this.handleUrlChange),this.clearTimer(),this.container.remove()}}window.customElements.whenDefined("home-assistant").then((()=>{const t=new URLSearchParams(window.location.search),e=t.get("screenTime"),s=t.get("allPage");if(e&&e<1)return;const i=()=>{const t=document.querySelector("home-assistant");if(t&&t.hass){const i={timeout:60,hassElement:t};try{const e=t.hass.states["input_number.screen_saver_timeout"];e&&(i.timeout=parseFloat(e.state))}catch(t){console.log("读取默认: 60 秒")}e&&(i.timeout=parseInt(e)),console.log(`${"0"==s?"仅lovelace页面":"所有页面"} 屏保时间: ${i.timeout} 秒。`),new ScreenSaver(i)}else setTimeout(i,100)};i()}));